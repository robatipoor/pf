<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paste File</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.qrcode@1.0.3/jquery.qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        #uploadForm {
            margin-bottom: 20px;
        }

        .progress-bar {
            display: none;
            width: 50%;
            background-color: #f1f1f1;
            margin-bottom: 20px;
            border: 3px solid rgb(255, 255, 255);
            margin: auto;

            &.is-active {
                display: block;
            }
        }

        .qr-code {
            display: none;
            margin: auto;

            &.is-active {
                display: block;
            }
        }

        .progress {
            width: 0%;
            height: 30px;
            background-color: #4caf50;
            line-height: 30px;
            color: white;
        }

        #qrcode {
            margin-top: 20px;
        }

        h1 {
            font-size: 20px;
            margin-top: 24px;
            margin-bottom: 24px;
        }

        img {
            height: 40px;
        }

        .success {
            display: none;
            background: #ffffff;
            padding: 20px;
            margin-top: 16px;
            margin-bottom: 16px;

            &.is-active {
                display: block;
            }
        }

        .topnav {
            text-align: center;
            background-color: #ffffff;
            overflow: hidden;
        }

        .topnav a {
            color: #000000;
            padding: 12px 14px;
            text-decoration: none;
            font-size: 20px;
        }

        .topnav a:hover {
            background-color: #ddd;
            color: black;
        }

        .topnav a.active {
            background-color: #161616;
            color: white;
        }

        .topnav a:focus {
            background-color: #161616;
            color: white;
        }
    </style>
</head>

<body>
    <h2>Paste File</h2>
    <div class="topnav">
        <a id="upload" class="active" href="#upload">Upload</a>
        <a id="copy" href="#copy">Copy</a>
        <a id="download" href="#download">Download</a>
    </div>
    <br>

    <div id="copyFormDiv" class="col-md-6 offset-md-3 mt-5" style="display:none">
        <form accept-charset="UTF-8" action="{{ domain }}/upload" method="POST" enctype="multipart/form-data"
            target="_blank" id="copyForm">
            <div class="form-group mr-3">
                <label for="codeLength">Code length: </label>
                <input type="number" name="codeLength" class="form-control" id="codeLength"
                    aria-describedby="codeLengthHelp" placeholder="Enter number length">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="expireSecs">Expire time: </label>
                <input type="number" name="expireSecs" class="form-control" id="expireSecs"
                    placeholder="Enter expire seconds">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="maxDownload">Maximum download: </label>
                <input size="12" type="number" name="maxDownload" class="form-control" id="maxDownload"
                    placeholder="Enter max downloads">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="username">Username: </label>
                <input type="text" name="Username" class="form-control" id="username" placeholder="Enter username">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="password">Password: </label>
                <input type="password" name="Password" class="form-control" id="password" placeholder="Enter password">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="allowManualDeletion">Allow manual deletion: </label>
                <select class="form-control" id="allowManualDeletion" name="platform">
                    <option>True</option>
                    <option>False</option>
                </select>
            </div>
            <div class="form-group mr-3">
                <p><label for="textInput">Text:</label></p>
                <textarea id="textInput" name="textInput" rows="20" cols="80"></textarea>
            </div>
            <br>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>

    <div id="downloadFormDiv" class="col-md-6 offset-md-3 mt-5" style="display:none">
        <div class="form-group mr-3">
            <label for="username">Username: </label>
            <input type="text" name="Username" class="form-control" id="username" placeholder="Enter username">
        </div>
        <br>
        <div class="form-group mr-3">
            <label for="password">Password: </label>
            <input type="password" name="Password" class="form-control" id="password" placeholder="Enter password">
        </div>
        <br>
        <div class="form-group mr-3">
            <label for="downloadUrl">File URL: </label>
            <input size="50" type="text" name="downloadUrl" class="form-control" id="downloadUrl" placeholder="Enter url">
        </div>
        <br>
        <button id="downloadFile" class="btn btn-primary">Download</button>
    </div>

    <div id="uploadFormDiv" class="col-md-6 offset-md-3 mt-5">
        <form accept-charset="UTF-8" action="{{ domain }}/upload" method="POST" enctype="multipart/form-data"
            target="_blank" id="uploadForm">
            <div class="form-group mr-3">
                <label for="codeLength">Code length: </label>
                <input type="number" name="codeLength" class="form-control" id="codeLength"
                    aria-describedby="codeLengthHelp" placeholder="Enter number length">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="expireSecs">Expire time: </label>
                <input type="number" name="expireSecs" class="form-control" id="expireSecs"
                    placeholder="Enter expire seconds">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="maxDownload">Maximum download: </label>
                <input size="12" type="number" name="maxDownload" class="form-control" id="maxDownload"
                    placeholder="Enter max downloads">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="username">Username: </label>
                <input type="text" name="Username" class="form-control" id="username" placeholder="Enter username">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="password">Password: </label>
                <input type="password" name="Password" class="form-control" id="password" placeholder="Enter password">
            </div>
            <br>
            <div class="form-group mr-3">
                <label for="allowManualDeletion">Allow manual deletion: </label>
                <select class="form-control" id="allowManualDeletion" name="platform">
                    <option>True</option>
                    <option>False</option>
                </select>
            </div>
            <br>
            <div class="form-group mr-3">
                <label>File: </label>
                <input type="file" name="file" required="required">
            </div>
            <br>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>
    <div class="progress-bar">
        <div id="progress" class="progress">0%</div>
    </div>
    <div id="urlDisplay" class="success">
        <p><span><strong id="result-url"></strong></span></p>
        <button id="copyButton">Copy to clipboard</button>
    </div>
    <div id="qrcode" class="qr-code"></div>
    <script>
        $("#copy").click(function (event) {
            event.preventDefault();
            $("#copyFormDiv").show();
            $('#uploadFormDiv').hide();
            $('#downloadFormDiv').hide();
            $('#copy').addClass('active');
            $('#upload').removeClass('active');
            $('#download').removeClass('active');
            $('.progress-bar').removeClass('is-active');
            $('.success').removeClass('is-active');
            $('.qr-code').removeClass('is-active');
        });

        $("#upload").click(function (event) {
            event.preventDefault();
            $("#uploadFormDiv").show();
            $('#copyFormDiv').hide();
            $('#downloadFormDiv').hide();
            $('#upload').addClass('active');
            $('#copy').removeClass('active');
            $('#download').removeClass('active');
            $('.progress-bar').removeClass('is-active');
            $('.success').removeClass('is-active');
            $('.qr-code').removeClass('is-active');
        });

        $("#download").click(function (event) {
            event.preventDefault();
            $("#downloadFormDiv").show();
            $('#copyFormDiv').hide();
            $('#uploadFormDiv').hide();
            $('#download').addClass('active');
            $('#copy').removeClass('active');
            $('#upload').removeClass('active');
            $('.progress-bar').removeClass('is-active');
            $('.success').removeClass('is-active');
            $('.qr-code').removeClass('is-active');
        });

        $("#copyForm").submit(function (e) {
            e.preventDefault();
            const fileNameLength = 5;
            var username = $("#username").val();
            var password = $("#password").val();
            var headers = { "Accept": "application/json" };
            if (username && password) {
                headers['Authorization'] = createBasicAuthHeader(username, password);
            } else if (username && !password) {
                alert('Please set password');
                return;
            } else if (!username && password) {
                alert('Please set username');
                return;
            }
            $('.progress-bar').addClass('is-active');
            var action = $(this).attr("action");
            var uploadUrl = createUploadURL(action);
            var textData = $("#textInput").val();
            if (!textData) {
                alert('Please set text');
                return;
            }
            var formData = new FormData();
            var blobData = new Blob([textData], {
                type: 'text/plain'
            });
            var filename = generateRandomString(fileNameLength).concat(".txt");
            formData.append('file', blobData, filename);
            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = (evt.loaded / evt.total) * 100;
                            $('#progress')[0].style.width = percentComplete + '%';
                            $('#progress')[0].innerHTML = percentComplete.toFixed(1) + '%';
                        }
                    }, false);
                    return xhr;
                },
                type: "POST",
                url: uploadUrl,
                crossDomain: true,
                data: formData,
                dataType: "json",
                contentType: "multipart/form-data",
                processData: false,
                contentType: false,
                headers: headers,
                success: function (response) {
                    $('.success').addClass('is-active');
                    $('#result-url').empty();
                    $("#result-url").append(response.url);
                    $('#qrcode').empty();
                    $('.qr-code').addClass('is-active');
                    $('#qrcode').qrcode({ width: 256, height: 256, text: response.url });
                },
            }).fail(function () {
                alert('An error occurred please try again later.');
            });
        });

        $("#uploadForm").submit(function (e) {
            e.preventDefault();
            var username = $("#username").val();
            var password = $("#password").val();
            var headers = { "Accept": "application/json" };
            if (username && password) {
                headers['Authorization'] = createBasicAuthHeader(username, password);
            } else if (username && !password) {
                alert('Please set password');
                return;
            } else if (!username && password) {
                alert('Please set username');
                return;
            }
            $('.progress-bar').addClass('is-active');
            var action = $(this).attr("action");
            var uploadUrl = createUploadURL(action);

            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = (evt.loaded / evt.total) * 100;
                            $('#progress')[0].style.width = percentComplete + '%';
                            $('#progress')[0].innerHTML = percentComplete.toFixed(1) + '%';
                        }
                    }, false);
                    return xhr;
                },
                type: "POST",
                url: uploadUrl,
                crossDomain: true,
                data: new FormData(this),
                dataType: "json",
                contentType: "multipart/form-data",
                processData: false,
                contentType: false,
                headers: headers,
                success: function (response) {
                    $('.success').addClass('is-active');
                    $('#result-url').empty();
                    $("#result-url").append(response.url);
                    $('#qrcode').empty();
                    $('.qr-code').addClass('is-active');
                    $('#qrcode').qrcode({ width: 256, height: 256, text: response.url });
                },
            }).fail(function () {
                alert('An error occurred please try again later.');
            });
        });

        $("#downloadFile").click(function (e) {
            e.preventDefault();
            var username = $("#username").val();
            var password = $("#password").val();
            var headers = { "Accept": "application/json" };
            if (username && password) {
                headers['Authorization'] = createBasicAuthHeader(username, password);
            } else if (username && !password) {
                alert('Please set password');
                return;
            } else if (!username && password) {
                alert('Please set username');
                return;
            }
            var url = $("#downloadUrl").val();
            var request = new XMLHttpRequest();
            request.open("GET", url);
            request.responseType = "blob";
            request.onload = function () {
                var a = document.createElement("a");
                a.href = URL.createObjectURL(this.response);
                a.download = "filename";
                document.body.appendChild(a);
                a.click();
            }
            request.send();
        });

        $("#copyButton").click(function (event) {
            event.preventDefault();
            navigator.clipboard.writeText($('#result-url').text()).then(() => { });
            alert('URL copied to clipboard!');
        });

        function createBasicAuthHeader(username, password) {
            return "Basic " + btoa(username + ':' + password);
        }

        function createUploadURL(base_url) {
            var result = base_url;
            var codeLength = $('#codeLength').val();
            var first = true;
            var d = "&";
            if (codeLength) {
                if (first) {
                    d = "?";
                    first = false;
                }
                result += d + "code_length=" + codeLength;
            }
            var expireSecs = $('#expireSecs').val();
            if (expireSecs) {
                if (first) {
                    d = "?";
                    first = false;
                } else {
                    d = "&"
                }
                result += d + "expire_secs=" + expireSecs;
            }
            var maxDownload = $('#maxDownload').val();
            if (maxDownload) {
                if (first) {
                    d = "?";
                }
                result += d + "max_download=" + maxDownload;
            }
            return result;
        }

        function generateRandomString(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            let counter = 0;
            while (counter < length) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
                counter += 1;
            }
            return result;
        }
    </script>
</body>

</html>